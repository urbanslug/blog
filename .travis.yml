language: generic

sudo: false

cache:
  directories:
    - $HOME/.stack/
    - $HOME/.local/bin/
    - .stack-work/

branches:
  only:
  - master

addons:
  ssh_known_hosts:
    - git.urbanslug.com

install:
  - mkdir -p ~/.local/bin
  - export PATH=~/.local/bin:$PATH
  - travis_retry curl -L https://www.stackage.org/stack/linux-x86_64 | tar -xzO --wildcards '*/stack' > ~/.local/bin/stack
  - chmod a+x ~/.local/bin/stack

#install:

script:
  - stack -j 2 setup --no-terminal
  - stack -j 2 build --only-snapshot --no-terminal
  - stack exec site build

after_success:
  - eval "$(ssh-agent -s)" #start the ssh agent
  - chmod 600 travis-ci
  - ssh-add travis-ci
  - cd _site
  - git init
  - git config --global user.email "$GIT_EMAIL"
  - git config --global user.name  "$GIT_NAME"
  - git remote add deploy "deploy@git.urbanslug.com:~/blog"
  - git add --all
  - git status
  - git commit -m "Built by Travis ( build $TRAVIS_BUILD_NUMBER )"
  - git push --force -v deploy master:master

env:
  global:
    - NIX_PATH: nixpkgs=https://github.com/NixOS/nixpkgs-channels/archive/b7e4857dd906022e4f996ae13ccb2988f2782de0.tar.gz
    - GIT_EMAIL: travis@travis-ci.org
    - GIT_NAME: Travis CI

before_install:
  - openssl aes-256-cbc -K $encrypted_7f9f7befb56d_key -iv $encrypted_7f9f7befb56d_iv -in travis-ci.enc -out travis-ci -d
